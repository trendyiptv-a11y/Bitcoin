name: Fetch J_BTC data

on:
  schedule:
    - cron: "0 5 * * *"   # opțional: zilnic la 05:00 UTC
  workflow_dispatch:       # ca să îl poți porni manual

permissions:
  contents: write          # IMPORTANT: permite commit/push

jobs:
  fetch-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      - name: Run fetch_all_data (tech metrics)
        run: |
          source .venv/bin/activate
          python fetch_all_data.py

      - name: Fetch custody data (C_custody real)
        env:
          GLASSNODE_API_KEY: ${{ secrets.GLASSNODE_API_KEY }}
        run: |
          source .venv/bin/activate
          python fetch_custody.py

      - name: Fetch governance data (C_gov real)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .venv/bin/activate
          python fetch_governance.py

      - name: Compute J_BTC from CSV (J_tech + J_soc + J_tot)
        run: |
          source .venv/bin/activate
          python compute_J_from_csv.py

      - name: Commit data changes
        run: |
          git config user.name "actions-user"
          git config user.email "actions@github.com"

          git add data

          # dacă nu sunt schimbări, nu dăm fail job-ului
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update J_BTC data [skip ci]"
            git push
          fi
