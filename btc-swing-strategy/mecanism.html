<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mecanism Coeziv BTC</title>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: rgba(15, 23, 42, 0.96);
      --border-card: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --accent-bull: #22c55e;
      --accent-bear: #f97373;
      --accent-neutral: #64748b;
      --accent-live: #38bdf8;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at 40% -10%, #0f172a, #000);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .shell { width: 100%; max-width: 520px; }
    .app-name { text-align:center; margin-bottom:6px; font-size:14px; opacity:.5; letter-spacing:.1em; }

    .card {
      background: var(--bg-card);
      border-radius: 24px;
      border: 1px solid var(--border-card);
      padding: 20px;
      box-shadow: 0 25px 70px rgba(0,0,0,.8);
    }

    .asset-row { display:flex; justify-content:space-between; align-items:center; }
    .asset-main { display:flex; gap:10px; align-items:center; }
    .asset-logo {
      width:28px; height:28px; border-radius:50%;
      font-size:15px; font-weight:700;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316);
      color:#0f172a;
    }

    .signal-chip {
      padding:4px 10px;
      font-size:11px;
      border-radius:999px;
      border:1px solid var(--accent-neutral);
      color:var(--accent-neutral);
      display:inline-flex; gap:6px; align-items:center;
    }
    .signal-dot { width:8px; height:8px; border-radius:50%; background:var(--accent-neutral); }

    .signal-chip.bullish { border-color:var(--accent-bull); color:var(--accent-bull); }
    .signal-chip.bullish .signal-dot { background:var(--accent-bull); }

    .signal-chip.bearish { border-color:var(--accent-bear); color:var(--accent-bear); }
    .signal-chip.bearish .signal-dot { background:var(--accent-bear); }

    .price-value { text-align:center; font-size:40px; font-weight:700; margin:18px 0 0; }
    .currency { text-align:center; font-size:12px; color:var(--text-muted); letter-spacing:.15em; }

    .live-row { text-align:center; margin-top:6px; font-size:12px; }
    .live-label { color:var(--accent-live); }
    .live-delta { margin-top:6px; text-align:center; font-size:11px; }
    .live-delta.positive { color:#4ade80; }
    .live-delta.negative { color:#fb7185; }

    .chart-block {
      margin:14px 0; height:240px;
      border-radius:12px; border:1px solid rgba(37,99,235,.25);
      overflow:hidden;
      background:radial-gradient(circle at 25% 0, rgba(37,99,235,.25), rgba(15,23,42,.92));
    }

    #btc-chart { width:100%; height:100%; }

    .message { text-align:center; margin:16px 0; font-size:14px; }
    .meta { text-align:center; font-size:11px; opacity:.7; }
    .error { text-align:center; margin-top:10px; color:#f97373; font-size:12px; }
  </style>

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
  <div class="shell">
    <div class="app-name">MECANISM COEZIV BTC</div>

    <div class="card">
      <div class="asset-row">
        <div class="asset-main">
          <div class="asset-logo">₿</div>
          <div>
            <div style="font-weight:600; font-size:18px;">Bitcoin (BTC)</div>
            <div style="font-size:11px; color:var(--text-muted);">Mecanism coeziv, actualizat orar.</div>
          </div>
        </div>

        <div id="signal-chip" class="signal-chip neutral">
          <span class="signal-dot"></span>
          <span id="signal-label">Semnal neutru (Flat)</span>
        </div>
      </div>

      <div class="price-value" id="price">–</div>
      <div class="currency">USD</div>

      <div class="live-row">
        <span class="live-label">Preț live:</span>
        <span id="live-price">–</span> USD
      </div>

      <div id="live-delta" class="live-delta">Se compară prețul live cu prețul mecanismului.</div>

      <div class="chart-block"><div id="btc-chart"></div></div>

      <div id="message" class="message">Se încarcă mesajul coeziv...</div>

      <div id="meta" class="meta">Snapshot: n/a • Generat: n/a</div>

      <div id="error" class="error"></div>
    </div>
  </div>

<script>
/* ================================
      CONFIG & UTILITARE
================================= */

const STATE_URL = "coeziv_state.json";

const USD = new Intl.NumberFormat("en-US", { maximumFractionDigits:0 });

function formatRO(iso) {
  if (!iso) return "n/a";
  const d = new Date(iso);
  return d.toLocaleString("ro-RO",{hour:"2-digit",minute:"2-digit",year:"numeric",month:"2-digit",day:"2-digit"});
}

function mapSignal(s) {
  s = (s||"").toLowerCase();
  if (s==="long")  return {tone:"bullish", label:"Semnal pozitiv (Long)"};
  if (s==="short") return {tone:"bearish", label:"Semnal negativ (Short)"};
  return {tone:"neutral", label:"Semnal neutru (Flat)"};
}

/* ================================
      VARIABILE GLOBALE
================================= */

let SNAPSHOT_PRICE = null;
let chart, candleSeries, signalSeries;
let CANDLES = [];

/* ================================
      ÎNCĂRCARE MECANISM JSON
================================= */

async function loadState() {
  try {
    const res = await fetch(STATE_URL + "?t=" + Date.now());
    const data = await res.json();

    SNAPSHOT_PRICE = data.price_usd || null;

    document.getElementById("price").textContent =
      SNAPSHOT_PRICE ? USD.format(SNAPSHOT_PRICE) : "–";

    const sig = mapSignal(data.signal);
    const chip = document.getElementById("signal-chip");
    chip.classList.remove("bullish","bearish","neutral");
    chip.classList.add(sig.tone);
    document.getElementById("signal-label").textContent = sig.label;

    document.getElementById("message").textContent =
      data.message || "Nu există mesaj coeziv.";

    document.getElementById("meta").innerHTML =
      `Snapshot: ${formatRO(data.timestamp)} • Generat: ${formatRO(data.generated_at)}`;

    updateSignalLine();
  } catch(e) {
    document.getElementById("error").textContent =
      "Nu am putut încărca coeziv_state.json.";
  }
}

/* ================================
      PREȚ LIVE BINANCE
================================= */

async function updateLivePrice() {
  try {
    const r = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT");
    const d = await r.json();
    const live = parseFloat(d.price);

    document.getElementById("live-price").textContent = USD.format(live);

    if (!SNAPSHOT_PRICE) return;

    const diff = live - SNAPSHOT_PRICE;
    const pct = diff / SNAPSHOT_PRICE * 100;

    const delta = document.getElementById("live-delta");
    delta.classList.remove("positive","negative");

    let t = "";
    const s = diff>=0 ? "+" : "";
    t += `Prețul live este ${s}${pct.toFixed(2)}% (${s}${USD.format(Math.abs(diff))} USD) `;

    if (diff > 0) {
      t += "peste prețul mecanismului.";
      delta.classList.add("positive");
    } else {
      t += "sub prețul mecanismului.";
      delta.classList.add("negative");
    }

    delta.textContent = t;
  } catch(e){}
}

/* ================================
      GRAFIC OHLC BINANCE (5M)
================================= */

function initChart() {
  const el = document.getElementById("btc-chart");
  chart = LightweightCharts.createChart(el,{
    layout:{ background:{color:"transparent"}, textColor:"#e5e7eb" },
    grid:{ vertLines:{color:"#1e293b"}, horzLines:{color:"#1e293b"} },
    timeScale:{ borderVisible:false },
    rightPriceScale:{ borderVisible:false }
  });

  candleSeries = chart.addCandlestickSeries({
    upColor:"#22c55e", downColor:"#ef4444",
    borderUpColor:"#22c55e", borderDownColor:"#ef4444",
    wickUpColor:"#22c55e", wickDownColor:"#ef4444"
  });

  signalSeries = chart.addLineSeries({ color:"#38bdf8", lineWidth:2 });

  loadOHLC();
  setupWebSocket();
}

function loadOHLC() {
  fetch("https://api.binance.com/api/v1/klines?symbol=BTCUSDT&interval=5m&limit=288")
    .then(r=>r.json())
    .then(rows=>{
      CANDLES = rows.map(k=>({
        time:k[0]/1000,
        open:parseFloat(k[1]),
        high:parseFloat(k[2]),
        low:parseFloat(k[3]),
        close:parseFloat(k[4])
      }));
      candleSeries.setData(CANDLES);
      chart.timeScale().fitContent();
      updateSignalLine();
    });
}

/* ================================
      WebSocket 5m LIVE CANDLES
================================= */

function setupWebSocket() {
  const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_5m");

  ws.onmessage = (msg)=>{
    const json = JSON.parse(msg.data);
    const k = json.k;

    const newCandle = {
      time: k.t/1000,
      open: parseFloat(k.o),
      high: parseFloat(k.h),
      low: parseFloat(k.l),
      close: parseFloat(k.c)
    };

    CANDLES[CANDLES.length-1] = newCandle;
    candleSeries.update(newCandle);
    updateSignalLine();
  };
}

/* ================================
      TRASARE LINIE MECANISM
================================= */

function updateSignalLine() {
  if (!SNAPSHOT_PRICE || !CANDLES.length) return;
  const lineData = CANDLES.map(c=>({time:c.time, value:SNAPSHOT_PRICE}));
  signalSeries.setData(lineData);
}

/* ================================
      START
================================= */

setTimeout(()=>initChart(),150);

loadState();
updateLivePrice();

setInterval(updateLivePrice, 8000);
setInterval(loadState, 5*60*1000);

</script>
</body>
</html>
