<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC – Mecanism Coeziv</title>
  <style>
    :root {
      --bg-main: #020617;
      --bg-card: rgba(15, 23, 42, 0.96);
      --border-card: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --accent-bull: #22c55e;
      --accent-bear: #f97373;
      --accent-neutral: #64748b;
      --accent-live: #38bdf8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 10% -10%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 90% 110%, #020617 0, #000 60%);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .shell {
      width: 100%;
      max-width: 520px;
    }

    .title-bar {
      text-align: center;
      margin-bottom: 12px;
    }

    .app-name {
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card {
      background: var(--bg-card);
      border-radius: 24px;
      border: 1px solid var(--border-card);
      box-shadow: 0 28px 80px rgba(0, 0, 0, 0.85);
      padding: 20px 20px 18px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0.12;
      pointer-events: none;
      background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.6), transparent 55%);
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .asset-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .asset-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .asset-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      background: radial-gradient(circle at 30% 0, #facc15, #f97316);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
      color: #0f172a;
    }

    .asset-text h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .asset-text span {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
    }

    .signal-chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-neutral);
      color: var(--accent-neutral);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .signal-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-neutral);
    }

    .signal-chip.bullish {
      border-color: var(--accent-bull);
      color: var(--accent-bull);
    }
    .signal-chip.bullish .signal-dot {
      background: var(--accent-bull);
    }

    .signal-chip.bearish {
      border-color: var(--accent-bear);
      color: var(--accent-bear);
    }
    .signal-chip.bearish .signal-dot {
      background: var(--accent-bear);
    }

    .signal-chip.neutral {
      border-color: var(--accent-neutral);
      color: var(--accent-neutral);
    }
    .signal-chip.neutral .signal-dot {
      background: var(--accent-neutral);
    }

    .price-block {
      text-align: center;
      margin: 18px 0 8px;
    }

    .price-value {
      font-size: 40px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .currency {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.16em;
      margin-top: 2px;
    }

    .live-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: baseline;
      gap: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .live-label {
      color: var(--accent-live);
      font-weight: 500;
    }

    .live-value {
      font-weight: 500;
    }

    .live-delta {
      font-size: 11px;
      text-align: center;
      margin-top: 2px;
      color: var(--text-soft);
    }

    .live-delta.positive {
      color: #4ade80;
    }

    .live-delta.negative {
      color: #fb7185;
    }

    .message {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-main);
      text-align: center;
      margin: 16px 0;
    }

    .meta {
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
    }

    .meta span {
      white-space: nowrap;
    }

    .meta-dot {
      margin: 0 4px;
      opacity: 0.6;
    }

    .error {
      margin-top: 10px;
      font-size: 12px;
      color: #f97373;
      text-align: center;
    }

    @media (max-width: 480px) {
      .card {
        padding: 18px 16px 16px;
        border-radius: 20px;
      }
      .price-value {
        font-size: 34px;
      }
      .asset-text h1 {
        font-size: 16px;
      }
      .message {
        font-size: 13px;
      }
      .live-row {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="title-bar">
      <div class="app-name">MECANISM COEZIV BTC</div>
    </div>

    <div class="card">
      <div class="card-inner">
        <div class="asset-row">
          <div class="asset-main">
            <div class="asset-logo">₿</div>
            <div class="asset-text">
              <h1>Bitcoin (BTC)</h1>
              <span>Mecanism coeziv, actualizat aproximativ la fiecare oră.</span>
            </div>
          </div>
          <div id="signal-chip" class="signal-chip neutral">
            <span class="signal-dot"></span>
            <span id="signal-label">Semnal neutru (Flat)</span>
          </div>
        </div>

        <div class="price-block">
          <div id="price" class="price-value">–</div>
          <div class="currency">USD</div>

          <!-- Preț live din CoinGecko -->
          <div class="live-row">
            <span class="live-label">Preț live:</span>
            <span id="live-price" class="live-value">–</span>
            <span class="live-currency">USD</span>
          </div>
          <div id="live-delta" class="live-delta">
            Se compară prețul live cu prețul analizat de mecanism.
          </div>
        </div>

        <div id="message" class="message">
          Se încarcă mesajul coeziv...
        </div>

        <div class="meta" id="meta">
          <span>Snapshot: n/a</span>
          <span class="meta-dot">•</span>
          <span>Generat: n/a</span>
        </div>

        <div id="error" class="error"></div>
      </div>
    </div>
  </div>

  <script>
    const PRICE_EL = document.getElementById("price");
    const MSG_EL = document.getElementById("message");
    const META_EL = document.getElementById("meta");
    const ERROR_EL = document.getElementById("error");
    const SIGNAL_CHIP_EL = document.getElementById("signal-chip");
    const SIGNAL_LABEL_EL = document.getElementById("signal-label");

    const LIVE_PRICE_EL = document.getElementById("live-price");
    const LIVE_DELTA_EL = document.getElementById("live-delta");

    // URL de bază pentru state-ul mecanismului
    const STATE_URL = "coeziv_state.json";

    // Formatter reutilizabil pentru USD, fără zecimale
    const USD_FORMATTER = new Intl.NumberFormat("en-US", {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });

    let SNAPSHOT_PRICE = null; // prețul din coeziv_state.json

    function mapSignal(signal) {
      const s = (signal || "").toLowerCase();
      if (s === "long") {
        return { tone: "bullish", label: "Semnal pozitiv (Long)" };
      }
      if (s === "short") {
        return { tone: "bearish", label: "Semnal negativ (Short)" };
      }
      return { tone: "neutral", label: "Semnal neutru (Flat)" };
    }

    function formatDate(iso) {
      if (!iso) return "n/a";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "n/a";
      return d.toLocaleString("ro-RO", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    async function loadState() {
      try {
        ERROR_EL.textContent = "";
        MSG_EL.textContent = "Se încarcă mesajul coeziv...";

        // cache-busting pentru a evita state vechi servit din cache
        const url = STATE_URL + "?t=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const state = await res.json();

        const price = state.price_usd;
        const message = state.message;
        const ts = state.timestamp;
        const gen = state.generated_at;
        const signal = state.signal;

        // preț snapshot (folosit de mecanism)
        if (typeof price === "number" && Number.isFinite(price) && price > 0) {
          SNAPSHOT_PRICE = price;
          PRICE_EL.textContent = USD_FORMATTER.format(price);
        } else {
          SNAPSHOT_PRICE = null;
          PRICE_EL.textContent = "–";
        }

        // mesaj coeziv (din backend, fără să-l schimbăm)
        MSG_EL.textContent = message || "Nu există mesaj coeziv pentru acest moment.";

        // semnal
        const mapped = mapSignal(signal);
        SIGNAL_LABEL_EL.textContent = mapped.label;
        SIGNAL_CHIP_EL.classList.remove("bullish", "bearish", "neutral");
        SIGNAL_CHIP_EL.classList.add(mapped.tone);
        SIGNAL_CHIP_EL.setAttribute("aria-label", mapped.label);

        // meta (timp)
        META_EL.innerHTML =
          `<span>Snapshot: ${formatDate(ts)}</span>` +
          `<span class="meta-dot">•</span>` +
          `<span>Generat: ${formatDate(gen)}</span>`;

        // dacă nu avem snapshot valid, clarificăm mesajul pentru live delta
        if (SNAPSHOT_PRICE === null) {
          LIVE_DELTA_EL.textContent =
            "Așteptăm un snapshot de preț valid din mecanism.";
          LIVE_DELTA_EL.classList.remove("positive", "negative");
        }
      } catch (err) {
        console.error(err);

        SNAPSHOT_PRICE = null;
        PRICE_EL.textContent = "–";
        LIVE_DELTA_EL.textContent =
          "Nu am putut încărca snapshotul de preț. Așteptăm ca mecanismul să revină.";
        LIVE_DELTA_EL.classList.remove("positive", "negative");

        ERROR_EL.textContent =
          "Nu am putut încărca coeziv_state.json. Verifică dacă workflow-ul de backend rulează corect.";
        MSG_EL.textContent = "Nu am reușit să obținem mesajul coeziv.";
      }
    }

    async function updateLivePrice() {
      try {
        const res = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd",
          { cache: "no-store" }
        );
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const live = data?.bitcoin?.usd;

        if (typeof live === "number" && Number.isFinite(live)) {
          LIVE_PRICE_EL.textContent = USD_FORMATTER.format(live);

          // dacă avem și snapshot valid, arătăm diferența
          if (
  typeof SNAPSHOT_PRICE === "number" &&
  Number.isFinite(SNAPSHOT_PRICE) &&
  SNAPSHOT_PRICE > 0
) {
  const diff = live - SNAPSHOT_PRICE;
  const pct = (diff / SNAPSHOT_PRICE) * 100;

  const sign = diff > 0 ? "+" : "";
  const dir = diff > 0 ? "peste" : "sub";
  const pctStr = pct.toFixed(2);

  const SIGNIFICANT_MOVE = 0.5; // 0.5% prag „serios”

  LIVE_DELTA_EL.classList.remove("positive", "negative");

  if (Math.abs(pct) >= SIGNIFICANT_MOVE) {
    LIVE_DELTA_EL.textContent =
      `Prețul live este ${sign}${pctStr}% ${dir} prețul analizat de mecanism.`;
    LIVE_DELTA_EL.classList.add(diff > 0 ? "positive" : "negative");
  } else {
    LIVE_DELTA_EL.textContent =
      `Prețul live este ${sign}${pctStr}% ${dir} prețul analizat de mecanism (diferență mică).`;
    // fără culoare verde/roșie, tocmai ca să nu exagereze importanța
  }
} else {
  LIVE_DELTA_EL.textContent =
    "Preț live încărcat. Așteptăm un snapshot de preț valid din mecanism.";
  LIVE_DELTA_EL.classList.remove("positive", "negative");
}
        }
      } catch (err) {
        console.error("Nu am putut obține prețul live BTC", err);
        // nu afișăm eroare mare în UI, doar lăsăm ultima valoare live
      }
    }

    // gestionăm intervalele în funcție de vizibilitatea tab-ului
    let stateInterval = null;
    let liveInterval = null;

    function startIntervals() {
      if (!stateInterval) {
        stateInterval = setInterval(loadState, 5 * 60 * 1000); // coeziv_state la 5 minute
      }
      if (!liveInterval) {
        liveInterval = setInterval(updateLivePrice, 15 * 1000); // preț live la 15 secunde
      }
    }

    function stopIntervals() {
      if (stateInterval) {
        clearInterval(stateInterval);
        stateInterval = null;
      }
      if (liveInterval) {
        clearInterval(liveInterval);
        liveInterval = null;
      }
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        // când revii în tab, faci un refresh imediat și repornești intervalele
        loadState();
        updateLivePrice();
        startIntervals();
      } else {
        // dacă tab-ul nu e vizibil, nu mai batem API-urile inutil
        stopIntervals();
      }
    });

    // load inițial și pornire intervale
    loadState();
    updateLivePrice();
    startIntervals();

  </script>
</body>
</html>
